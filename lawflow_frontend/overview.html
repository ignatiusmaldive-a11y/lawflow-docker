<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LawFlow - Project Overview</title>
    <style>
      :root{
        --bg: #0b1220;
        --panel: #1a202d;
        --panel2: #212734;
        --text: #f7fafc;
        --muted: #a0aec0;
        --line: #2d3748;
        --shadow: 0 18px 50px rgba(0,0,0,.45);
        --radius: 18px;

        --brand: #7c3aed;
        --brand2: #22c55e;
        --warn: #f59e0b;
        --danger: #ef4444;
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background:
          radial-gradient(1200px 800px at 15% 0%, rgba(124,58,237,.25), transparent 55%),
          radial-gradient(900px 700px at 80% 20%, rgba(34,197,94,.16), transparent 55%),
          var(--bg);
        color: var(--text);
      }
      a{ color:inherit; text-decoration:none; }
      button, input, select { font: inherit; }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: var(--text);
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 900;
      }

      .header p {
        color: var(--muted);
        font-size: 1.1rem;
      }

      .loading {
        text-align: center;
        padding: 50px;
        font-size: 1.2rem;
        color: var(--muted);
      }

      .error {
        background: var(--panel);
        color: var(--text);
        padding: 20px;
        border-radius: var(--radius);
        border: 1px solid var(--danger);
        margin: 20px 0;
        text-align: center;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .stat-card {
        border: 1px solid var(--line);
        background: var(--panel2);
        border-radius: var(--radius);
        box-shadow: 0 14px 35px rgba(0,0,0,.18);
        padding: 24px;
        text-align: center;
      }

      .stat-value {
        font-size: 22px;
        font-weight: 1000;
        color: var(--brand);
        margin-bottom: 8px;
      }

      .stat-label {
        color: var(--muted);
        font-weight: 800;
        font-size: 12px;
        margin-bottom: 4px;
      }

      .stat-desc {
        color: var(--muted);
        font-size: 12px;
      }

      .search-container {
        margin-bottom: 20px;
        text-align: center;
      }

      .search-input {
        width: min(360px, 48vw);
        padding: 10px 12px;
        border-radius: 14px;
        background: var(--panel);
        border: 1px solid var(--line);
        color: var(--text);
        outline: none;
        transition: background 0.2s;
      }

      .search-input:focus {
        background: var(--panel2);
      }

      .search-input::placeholder {
        color: var(--muted);
      }

      .projects-table {
        border: 1px solid var(--line);
        background: var(--panel2);
        border-radius: var(--radius);
        box-shadow: 0 14px 35px rgba(0,0,0,.18);
        overflow: hidden;
      }

      .projects-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .projects-table th {
        background: var(--panel);
        color: var(--muted);
        padding: 14px;
        text-align: left;
        font-weight: 900;
        font-size: 12px;
        border-bottom: 1px solid var(--line);
      }

      .projects-table td {
        padding: 14px;
        border-bottom: 1px solid var(--line);
        color: var(--text);
        vertical-align: top;
      }

      .projects-table tbody tr {
        transition: background-color 0.2s;
        cursor: pointer;
      }

      .projects-table tbody tr:hover {
        background: var(--panel);
      }

      .project-title {
        font-weight: 950;
        color: var(--brand);
        margin-bottom: 4px;
        line-height: 1.25;
      }

      .project-meta {
        font-size: 12px;
        color: var(--muted);
        font-weight: 900;
      }

      .pill{
        font-size: 12px; padding: 4px 10px; border-radius: 999px;
        border: 1px solid var(--line); background: var(--panel); color: var(--muted);
        display: inline-block;
      }
      .pill.warn{ border-color: color-mix(in oklab, var(--warn) 55%, var(--line)); color: color-mix(in oklab, var(--warn) 85%, white); }
      .pill.ok{ border-color: color-mix(in oklab, var(--brand2) 55%, var(--line)); color: color-mix(in oklab, var(--brand2) 85%, white); }
      .pill.bad{ border-color: color-mix(in oklab, var(--danger) 55%, var(--line)); color: color-mix(in oklab, var(--danger) 85%, white); }
      .pill.primary{ border-color: color-mix(in oklab, #4299e1 55%, var(--line)); color: color-mix(in oklab, #4299e1 85%, white); }
      .pill.secondary{ border-color: color-mix(in oklab, #9f7aea 55%, var(--line)); color: color-mix(in oklab, #9f7aea 85%, white); }

      .deadline-overdue { color: var(--danger); font-weight: 600; }
      .deadline-soon { color: var(--warn); font-weight: 600; }
      .deadline-normal { color: var(--muted); }

      .no-results {
        text-align: center;
        padding: 60px 20px;
        color: var(--muted);
        font-style: italic;
      }

      .back-link {
        position: fixed;
        top: 16px;
        left: 16px;
        color: var(--brand);
        text-decoration: none;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--text);
        cursor:pointer;
        font-weight: 800;
        font-size: 14px;
        transition: all 0.2s;
      }

      .back-link:hover {
        background: var(--panel2);
        border-color: color-mix(in oklab, var(--brand) 35%, var(--line));
      }

      /* Responsive design - matching main app */
      @media (max-width: 1100px){
        .container { padding: 16px; }
      }

      @media (max-width: 1040px){
        .stats-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .search-input{ width: min(280px, 40vw); }
      }

      @media (max-width: 680px){
        .container{ padding: 16px; }
        .header h1{ font-size: 2rem; }
        .stats-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .search-input{ width: 100%; }
      }

      @media (max-width: 480px){
        .stats-grid{ grid-template-columns: 1fr; }
        .projects-table{ font-size: 0.9rem; }
        .projects-table th, .projects-table td{ padding: 10px 12px; }
      }
    </style>
  </head>
  <body>
    <a href="/" class="back-link">← Back to LawFlow</a>

    <div class="container">
      <div class="header">
        <h1>LawFlow Project Overview</h1>
        <p>Comprehensive view of all current and past projects</p>
      </div>

      <div id="loading" class="loading">
        Loading project data...
      </div>

      <div id="error" class="error" style="display: none;">
        Failed to load project data. Please check your connection.
      </div>

      <div id="content" style="display: none;">
        <div id="stats" class="stats-grid">
          <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="search-container">
          <input
            type="text"
            id="search"
            class="search-input"
            placeholder="Search projects by title, location, or status..."
          />
        </div>

        <div class="projects-table">
          <table id="projects-table">
            <thead>
              <tr>
                <th>Project Title</th>
                <th>Location</th>
                <th>Status</th>
                <th>Risk</th>
                <th>Type</th>
                <th>Target Close</th>
                <th>Client</th>
              </tr>
            </thead>
            <tbody id="projects-body">
              <!-- Projects will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <div id="no-results" class="no-results" style="display: none;">
          No projects match your search criteria.
        </div>
      </div>
    </div>

    <script type="module">
      const API_BASE = '/api';
      let allProjects = [];

      // Helper functions
      function riskPill(risk) {
        if (risk === "Critical") return '<span class="pill bad">Critical</span>';
        if (risk === "At Risk") return '<span class="pill warn">At risk</span>';
        return '<span class="pill ok">Normal</span>';
      }

      function statusPill(status) {
        const colors = {
          "Due Diligence": "warn",
          "Contracts": "warn",
          "Notary": "bad",
          "Registry": "ok",
          "Completed": "ok"
        };
        return `<span class="pill ${colors[status] || "neutral"}">${status}</span>`;
      }

      function fmtDateShort(d) {
        if (!d) return "—";
        const dt = new Date(d + "T00:00:00");
        return dt.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
      }

      function daysUntil(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr + "T00:00:00");
        const now = new Date();
        const ms = d.getTime() - new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        return Math.round(ms / (1000 * 60 * 60 * 24));
      }

      function renderStats(projects) {
        const total = projects.length;
        const active = projects.filter(p => !["Completed", "Registry"].includes(p.status)).length;
        const completed = projects.filter(p => p.status === "Registry" || p.status === "Completed").length;
        const critical = projects.filter(p => p.risk === "Critical").length;
        const atRisk = projects.filter(p => p.risk === "At Risk").length;

        const statsHtml = `
          <div class="stat-card">
            <div class="stat-value">${total}</div>
            <div class="stat-label">Total Projects</div>
            <div class="stat-desc">All matters</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${active}</div>
            <div class="stat-label">Active Projects</div>
            <div class="stat-desc">In progress</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${completed}</div>
            <div class="stat-label">Completed</div>
            <div class="stat-desc">Closed matters</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${critical + atRisk}</div>
            <div class="stat-label">High Risk</div>
            <div class="stat-desc">Need attention</div>
          </div>
        `;

        document.getElementById('stats').innerHTML = statsHtml;
      }

      function renderProjects(projects) {
        const tbody = document.getElementById('projects-body');
        const noResults = document.getElementById('no-results');

        if (projects.length === 0) {
          tbody.innerHTML = '';
          noResults.style.display = 'block';
          return;
        }

        noResults.style.display = 'none';

        const rows = projects.map(project => {
          const daysLeft = daysUntil(project.target_close_date);
          const isOverdue = daysLeft !== null && daysLeft < 0;
          const isDueSoon = daysLeft !== null && daysLeft <= 7 && daysLeft >= 0;

          const deadlineClass = isOverdue ? 'deadline-overdue' : isDueSoon ? 'deadline-soon' : 'deadline-normal';
          const deadlineText = daysLeft !== null ?
            (isOverdue ? `${Math.abs(daysLeft)} days overdue` :
             daysLeft === 0 ? "Due today" :
             daysLeft === 1 ? "Tomorrow" :
             `${daysLeft} days left`) : '';

          return `
            <tr onclick="window.location.href='/?project=${project.id}'">
              <td>
                <div class="project-title">${project.title}</div>
                <div class="project-meta">ID: ${project.id} • Started: ${fmtDateShort(project.start_date)}</div>
              </td>
              <td><span class="pill neutral">${project.location}</span></td>
              <td>${statusPill(project.status)}</td>
              <td>${riskPill(project.risk)}</td>
              <td><span class="pill ${project.transaction_type === 'Purchase' ? 'primary' : 'secondary'}">${project.transaction_type}</span></td>
              <td>
                <div class="${deadlineClass}">${fmtDateShort(project.target_close_date)}</div>
                ${deadlineText ? `<div style="font-size: 0.8rem; margin-top: 2px;">${deadlineText}</div>` : ''}
              </td>
              <td>${project.client?.name || "—"}</td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = rows;
      }

      function filterProjects(projects, query) {
        if (!query.trim()) return projects;

        const q = query.toLowerCase();
        return projects.filter(p =>
          p.title.toLowerCase().includes(q) ||
          p.location.toLowerCase().includes(q) ||
          p.status.toLowerCase().includes(q)
        );
      }

      // Load data
      async function loadData() {
        try {
          const response = await fetch(`${API_BASE}/projects`);
          if (!response.ok) throw new Error('Failed to fetch projects');

          allProjects = await response.json();

          document.getElementById('loading').style.display = 'none';
          document.getElementById('content').style.display = 'block';

          renderStats(allProjects);
          renderProjects(allProjects);

        } catch (error) {
          console.error('Error loading data:', error);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').style.display = 'block';
        }
      }

      // Search functionality
      document.getElementById('search').addEventListener('input', (e) => {
        const filtered = filterProjects(allProjects, e.target.value);
        renderProjects(filtered);
      });

      // Initialize
      loadData();
    </script>
  </body>
</html>